{"version":3,"sources":["backend/AgendaEdit.ts"],"names":["AgendaEdit","$widget","_this","this","hasChanged","delAgendaItemStr","$agendaform","$","$agenda","addClass","nestedSortable","handle","items","toleranceElement","placeholder","tolerance","forcePlaceholderSize","helper","axis","update","showSaver","trigger","find","each","i","el","prepareAgendaItem","prepareAgendaList","locale","attr","datetimepicker","format","stepping","preDate","data","moment","defaultDate","on","agendaItemAdd","bind","agendaDateAdd","showTimesChanges","delAgendaItem","editAgendaItem","submitSingleItemForm","submitDateItemForm","submitCompleteForm","prototype","buildAgendaStruct","$ol","children","$li","id","split","length","date","val","push","type","title","$form","time","prop","code","motionTypeId","inProposedProcedures","ev","preventDefault","target","parents","first","newTitle","newDate","fullString","removeClass","text","newCode","newTime","console","log","prepend","remove","JSON","stringify","window","off","onLeavePage","$this","bootbox","confirm","__t","result","$newElement","before","$item","append","stopPropagation","$list","full","str","$el","hasClass","exports"],"mappings":"yGAIA,IAAAA,EAAA,WAQI,SAAAA,EAAoBC,GAApB,IAAAC,EAAAC,KAAoBA,KAAAF,QAAAA,EAPZE,KAAAC,YAAsB,EAKtBD,KAAAE,iBAAmB,6FAGvBF,KAAKG,YAAcC,EAAE,2BACrBJ,KAAKK,QAAUD,EAAE,2BAEjBJ,KAAKK,QAAQC,SAAS,qBACtBN,KAAKK,QAAQE,eAAe,CACxBC,OAAQ,cACRC,MAAO,gBACPC,iBAAkB,QAClBC,YAAa,kBACbC,UAAW,UACXC,sBAAsB,EACtBC,OAAQ,QACRC,KAAM,IACNC,OAAQ,WACJjB,EAAKkB,YACLb,EAAE,6BAA6Bc,QAAQ,iCAG/ClB,KAAKK,QAAQc,KAAK,eAAeC,KAAK,SAACC,EAAGC,GACtCvB,EAAKwB,kBAAkBnB,EAAEkB,MAE7BtB,KAAKwB,kBAAkBxB,KAAKK,SAAS,GACrCL,KAAKK,QAAQc,KAAK,aAAaC,KAAK,SAACC,EAAGC,GACpCvB,EAAKyB,kBAAkBpB,EAAEkB,IAAK,KAGlCtB,KAAKyB,OAASrB,EAAE,QAAQsB,KAAK,QAC7B1B,KAAKK,QAAQc,KAAK,qBAAqBQ,eAAe,CAClDF,OAAQzB,KAAKyB,OACbG,OAAQ,KACRC,SAAU,IAEd7B,KAAKK,QAAQc,KAAK,qBAAqBC,KAAK,SAACC,EAAGC,GAC5C,IAAIQ,EAAU,KACV1B,EAAEkB,GAAIS,KAAK,UACXD,EAAUE,OAAO5B,EAAEkB,GAAIS,KAAK,QAAS,aAAchC,EAAK0B,SAE5DrB,EAAEkB,GAAIK,eAAe,CACjBF,OAAQ1B,EAAK0B,OACbG,OAAQ,qBACRK,YAAaH,MAKrB9B,KAAKK,QAAQ6B,GAAG,QAAS,6BAA8BlC,KAAKmC,cAAcC,KAAKpC,OAC/EA,KAAKK,QAAQ6B,GAAG,QAAS,4BAA6BlC,KAAKqC,cAAcD,KAAKpC,OAC9EA,KAAKK,QAAQ6B,GAAG,SAAU,oCAAqClC,KAAKsC,iBAAiBF,KAAKpC,OAC1FA,KAAKK,QAAQ6B,GAAG,QAAS,iBAAkBlC,KAAKuC,cAAcH,KAAKpC,OACnEA,KAAKK,QAAQ6B,GAAG,QAAS,kBAAmBlC,KAAKwC,eAAeJ,KAAKpC,OACrEA,KAAKK,QAAQ6B,GAAG,SAAU,sBAAuBlC,KAAKyC,qBAAqBL,KAAKpC,OAChFA,KAAKK,QAAQ6B,GAAG,SAAU,sBAAuBlC,KAAK0C,mBAAmBN,KAAKpC,OAC9EA,KAAKG,YAAY+B,GAAG,SAAUlC,KAAK2C,mBAAmBP,KAAKpC,OA0LnE,OAvLIH,EAAA+C,UAAAC,kBAAA,SAAkBC,GAAlB,IAAA/C,EAAAC,KACQS,EAAQ,GA+BZ,OA9BAqC,EAAIC,SAAS,eAAe3B,KAAK,SAACC,EAAGC,GACjC,IAAM0B,EAAM5C,EAAEkB,GACV2B,EAAKD,EAAItB,KAAK,MAAMwB,MAAM,KAC9B,GAAqD,EAAjDF,EAAI7B,KAAK,+BAA+BgC,OAAY,CACpD,IAAIC,EAAOJ,EAAI7B,KAAK,gDAAgDkC,MACpE5C,EAAM6C,KAAK,CACPC,KAAQ,OACRN,GAAMA,EAAG,GACTG,KAAQpB,OAAOoB,EAAM,qBAAsBrD,EAAK0B,QAAQG,OAAO,KAC/D4B,MAASR,EAAI7B,KAAK,iDAAiDkC,MACnEN,SAAYhD,EAAK8C,kBAAkBG,EAAI7B,KAAK,eAE7C,CACH,IAAMsC,EAAQT,EAAI7B,KAAK,+BACnBuC,EAAO,KACP3D,EAAKD,QAAQqB,KAAK,qCAAqCwC,KAAK,aAC5DD,EAAOV,EAAI7B,KAAK,gDAAgDkC,OAEpE5C,EAAM6C,KAAK,CACPC,KAAQ,MACRN,GAAMA,EAAG,GACTS,KAAQA,EACRE,KAAQH,EAAMtC,KAAK,oBAAoBkC,MACvCG,MAASC,EAAMtC,KAAK,qBAAqBkC,MACzCQ,aAAgBJ,EAAMtC,KAAK,2BAA2BkC,MACtDS,qBAAwBL,EAAMtC,KAAK,mDAAmDwC,KAAK,WAC3FZ,SAAYhD,EAAK8C,kBAAkBG,EAAI7B,KAAK,cAIjDV,GAGXZ,EAAA+C,UAAAF,mBAAA,SAAmBqB,GACfA,EAAGC,iBACHhE,KAAKiB,YAEL,IAAI+B,EAAM5C,EAAE2D,EAAGE,QAAQC,QAAQ,iBAAiBC,QAC5CV,EAAQrD,EAAE2D,EAAGE,QACbG,EAAWX,EAAMtC,KAAK,qBAAqBkC,MAC3CgB,EAAUZ,EAAMtC,KAAK,oBAAoBkC,MACzCiB,EAAa,GACbD,IACAC,GAAcD,GAEdA,GAAWD,IACXE,GAAc,MAEdF,IACAE,GAAcF,GAElBpB,EAAIuB,YAAY,WAChBvB,EAAI7B,KAAK,qBAAqBqD,KAAKF,GACnClE,EAAE,6BAA6Bc,QAAQ,+BAG3CrB,EAAA+C,UAAAH,qBAAA,SAAqBsB,GACjBA,EAAGC,iBACHhE,KAAKiB,YACL,IAAI+B,EAAM5C,EAAE2D,EAAGE,QAAQC,QAAQ,iBAAiBC,QAC5CV,EAAQrD,EAAE2D,EAAGE,QACbG,EAAWX,EAAMtC,KAAK,qBAAqBkC,MAC3CoB,EAAUhB,EAAMtC,KAAK,oBAAoBkC,MACzCqB,EAAUjB,EAAMtC,KAAK,oBAAoBkC,MAC7CL,EAAIuB,YAAY,WAChBvB,EAAIjB,KAAK,OAAQ0C,GACjBzB,EAAI7B,KAAK,oBAAoBqD,KAAKC,GAClCzB,EAAI7B,KAAK,qBAAqBqD,KAAKJ,GAC/BpE,KAAKF,QAAQqB,KAAK,qCAAqCwC,KAAK,YAAce,GAC9B,IAAxC1B,EAAI7B,KAAK,oBAAoBgC,SAC7BwB,QAAQC,IAAI,WACZ5B,EAAI7B,KAAK,cAAc0D,QAAQ,+BAEnC7B,EAAI7B,KAAK,oBAAoBqD,KAAKE,IAElC1B,EAAI7B,KAAK,oBAAoB2D,SAEjC1E,EAAE,6BAA6Bc,QAAQ,+BAG3CrB,EAAA+C,UAAAD,mBAAA,WACI,IAAIZ,EAAO/B,KAAK6C,kBAAkBzC,EAAE,4BACpCJ,KAAKG,YAAYgB,KAAK,oBAAoBkC,IAAI0B,KAAKC,UAAUjD,IAC7D3B,EAAE6E,QAAQC,IAAI,eAAgBrF,EAAWsF,cAG7CtF,EAAA+C,UAAAL,cAAA,SAAcwB,GAAd,IAAAhE,EAAAC,KACQoF,EAAQhF,EAAE2D,EAAGE,QACjBF,EAAGC,iBACHqB,QAAQC,QAAQC,IAAI,QAAS,yBAA0B,SAACC,GAChDA,IACAzF,EAAKkB,YACLmE,EAAMlB,QAAQ,iBAAiBC,QAAQW,SACvC1E,EAAE,6BAA6Bc,QAAQ,kCAKnDrB,EAAA+C,UAAAJ,eAAA,SAAeuB,GACXA,EAAGC,iBACHhE,KAAKiB,YACL,IAAI+B,EAAM5C,EAAE2D,EAAGE,QAAQC,QAAQ,iBAAiBC,QAChDnB,EAAI1C,SAAS,WACb0C,EAAI7B,KAAK,gDAAgDD,QAAQ,SAASA,QAAQ,WAGtFrB,EAAA+C,UAAAT,cAAA,SAAc4B,GACVA,EAAGC,iBACHhE,KAAKiB,YACL,IAAIwE,EAAcrF,EAAEA,EAAE,6BAA6BiD,OACtCjD,EAAE2D,EAAGE,QAAQC,QAAQ,oBAAoBC,QAC/CuB,OAAOD,GACdzF,KAAKuB,kBAAkBkE,GACvBzF,KAAKwB,kBAAkBiE,EAAYtE,KAAK,cAAc,GACtDsE,EAAYtE,KAAK,mBAAmBD,QAAQ,SAC5CuE,EAAYtE,KAAK,kCAAkCD,QAAQ,SAC3DuE,EAAYtE,KAAK,qBAAqBQ,eAAe,CACjDF,OAAQzB,KAAKyB,OACbG,OAAQ,QAIhB/B,EAAA+C,UAAAP,cAAA,SAAc0B,GACVA,EAAGC,iBACHhE,KAAKiB,YACL,IAAIwE,EAAcrF,EAAEA,EAAE,0BAA0BiD,OACnCjD,EAAE2D,EAAGE,QAAQC,QAAQ,oBAAoBC,QAC/CuB,OAAOD,GACdzF,KAAKuB,kBAAkBkE,GACvBzF,KAAKwB,kBAAkBiE,EAAYtE,KAAK,cAAc,GACtDsE,EAAYtE,KAAK,mBAAmBD,QAAQ,SAC5CuE,EAAYtE,KAAK,qBAAqBQ,eAAe,CACjDF,OAAQzB,KAAKyB,OACbG,OAAQ,wBAIhB/B,EAAA+C,UAAAN,iBAAA,WACQtC,KAAKF,QAAQqB,KAAK,qCAAqCwC,KAAK,WAC5D3D,KAAKK,QAAQC,SAAS,aAAaiE,YAAY,eAE/CvE,KAAKK,QAAQkE,YAAY,aAAajE,SAAS,gBAIvDT,EAAA+C,UAAArB,kBAAA,SAAkBoE,GACdA,EAAMxE,KAAK,SAAS0D,QAAQ,wEAC5Bc,EAAMxE,KAAK,cAAcyE,OAAO,2FAChCD,EAAMxE,KAAK,cAAcyE,OAAO5F,KAAKE,kBACrCyF,EAAMxE,KAAK,eAAee,GAAG,QAAS,SAAC6B,GACnCA,EAAG8B,qBAIXhG,EAAA+C,UAAApB,kBAAA,SAAkBsE,EAAOC,GACrB,IAAIC,EAAM,0KACgFT,IAAI,QAAS,kBAAoB,OACvHQ,IACAC,GAAO,mFAAqFT,IAAI,QAAS,iBAAmB,sGAEpDA,IAAI,QAAS,mBAAqB,YAE9GS,GAAO,QACP,IAAMC,EAAM7F,EAAE4F,GACVhG,KAAKK,QAAQ6F,SAAS,cACtBD,EAAI9E,KAAK,oBAAoBwC,KAAK,WAAW,GAEjDmC,EAAMF,OAAOK,IAGjBpG,EAAA+C,UAAA3B,UAAA,WACIb,EAAE,2BAA2BmE,YAAY,UACzCvE,KAAKC,YAAa,EACbG,EAAE,QAAQ8F,SAAS,YACpB9F,EAAE6E,QAAQ/C,GAAG,eAAgBrC,EAAWsF,cAIlCtF,EAAAsF,YAAd,WACI,OAAOI,IAAI,MAAO,uBAE1B1F,EAvPA,GAAasG,EAAAtG,WAAAA","file":"AgendaEdit.js","sourcesContent":["/// <reference path=\"../typings/nestedSortable/index.d.ts\" />\n\ndeclare let moment: any;\n\nexport class AgendaEdit {\n    private hasChanged: boolean = false;\n    private $agendaform: JQuery;\n    private readonly $agenda: JQuery;\n    private readonly locale: string;\n\n    private delAgendaItemStr = '<a href=\"#\" class=\"delAgendaItem\"><span class=\"glyphicon glyphicon-minus-sign\"></span></a>';\n\n    constructor(private $widget: JQuery) {\n        this.$agendaform = $('#agendaEditSavingHolder');\n        this.$agenda = $('.motionListWithinAgenda');\n\n        this.$agenda.addClass('agendaListEditing');\n        this.$agenda.nestedSortable({\n            handle: '.moveHandle',\n            items: 'li.agendaItem',\n            toleranceElement: '> div',\n            placeholder: 'movePlaceholder',\n            tolerance: 'pointer',\n            forcePlaceholderSize: true,\n            helper: 'clone',\n            axis: 'y',\n            update: () => {\n                this.showSaver();\n                $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n        this.$agenda.find('.agendaItem').each((i, el) => {\n            this.prepareAgendaItem($(el));\n        });\n        this.prepareAgendaList(this.$agenda, true);\n        this.$agenda.find('ol.agenda').each((i, el) => {\n            this.prepareAgendaList($(el), false);\n        });\n\n        this.locale = $(\"html\").attr('lang');\n        this.$agenda.find(\".input-group.time\").datetimepicker({\n            locale: this.locale,\n            format: 'LT',\n            stepping: 5\n        });\n        this.$agenda.find(\".input-group.date\").each((i, el) => {\n            let preDate = null;\n            if ($(el).data(\"date\")) {\n                preDate = moment($(el).data(\"date\"), \"YYYY-MM-DD\", this.locale);\n            }\n            $(el).datetimepicker({\n                locale: this.locale,\n                format: 'dddd, Do MMMM YYYY',\n                defaultDate: preDate\n            });\n        });\n\n\n        this.$agenda.on('click', '.agendaItemAdder .addEntry', this.agendaItemAdd.bind(this));\n        this.$agenda.on('click', '.agendaItemAdder .addDate', this.agendaDateAdd.bind(this));\n        this.$agenda.on('change', '.agendaItemAdder .showTimes input', this.showTimesChanges.bind(this));\n        this.$agenda.on('click', '.delAgendaItem', this.delAgendaItem.bind(this));\n        this.$agenda.on('click', '.editAgendaItem', this.editAgendaItem.bind(this));\n        this.$agenda.on('submit', '.agendaItemEditForm', this.submitSingleItemForm.bind(this));\n        this.$agenda.on('submit', '.agendaDateEditForm', this.submitDateItemForm.bind(this));\n        this.$agendaform.on(\"submit\", this.submitCompleteForm.bind(this));\n    }\n\n    buildAgendaStruct($ol) {\n        let items = [];\n        $ol.children('.agendaItem').each((i, el) => {\n            const $li = $(el),\n                id = $li.attr('id').split('_');\n            if ($li.find('> div > .agendaDateEditForm').length > 0) {\n                let date = $li.find('> div > .agendaDateEditForm input[name=date]').val();\n                items.push({\n                    'type': 'date',\n                    'id': id[1],\n                    'date': moment(date, 'dddd, Do MMMM YYYY', this.locale).format('L'),\n                    'title': $li.find('> div > .agendaDateEditForm input[name=title]').val(),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            } else {\n                const $form = $li.find('> div > .agendaItemEditForm');\n                let time = null;\n                if (this.$widget.find('.agendaItemAdder .showTimes input').prop(\"checked\")) {\n                    time = $li.find('> div > .agendaItemEditForm input[name=time]').val();\n                }\n                items.push({\n                    'type': 'std',\n                    'id': id[1],\n                    'time': time,\n                    'code': $form.find('input[name=code]').val(),\n                    'title': $form.find('input[name=title]').val(),\n                    'motionTypeId': $form.find('select[name=motionType]').val(),\n                    'inProposedProcedures': $form.find('.extraSettings input[name=inProposedProcedures]').prop('checked'),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            }\n        });\n        return items;\n    }\n\n    submitDateItemForm(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $form = $(ev.target),\n            newTitle = $form.find('input[name=title]').val() as string,\n            newDate = $form.find('input[name=date]').val() as string,\n            fullString = '';\n        if (newDate) {\n            fullString += newDate;\n        }\n        if (newDate && newTitle) {\n            fullString += ': ';\n        }\n        if (newTitle) {\n            fullString += newTitle;\n        }\n        $li.removeClass('editing');\n        $li.find('> div > h3 .title').text(fullString);\n        $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n    }\n\n    submitSingleItemForm(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $form = $(ev.target),\n            newTitle = $form.find('input[name=title]').val() as string,\n            newCode = $form.find('input[name=code]').val() as string,\n            newTime = $form.find('input[name=time]').val() as string;\n        $li.removeClass('editing');\n        $li.data('code', newCode);\n        $li.find('> div > h3 .code').text(newCode);\n        $li.find('> div > h3 .title').text(newTitle);\n        if (this.$widget.find('.agendaItemAdder .showTimes input').prop(\"checked\") && newTime) {\n            if ($li.find('> div > h3 .time').length === 0) {\n                console.log(\"prepend\");\n                $li.find('> div > h3').prepend('<span class=\"time\"></span>');\n            }\n            $li.find('> div > h3 .time').text(newTime);\n        } else {\n            $li.find('> div > h3 .time').remove();\n        }\n        $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n    }\n\n    submitCompleteForm() {\n        let data = this.buildAgendaStruct($('.motionListWithinAgenda'));\n        this.$agendaform.find('input[name=data]').val(JSON.stringify(data));\n        $(window).off(\"beforeunload\", AgendaEdit.onLeavePage);\n    }\n\n    delAgendaItem(ev: Event) {\n        let $this = $(ev.target);\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"agendaDelEntryConfirm\"), (result) => {\n            if (result) {\n                this.showSaver();\n                $this.parents('li.agendaItem').first().remove();\n                $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n    }\n\n    editAgendaItem(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first();\n        $li.addClass('editing');\n        $li.find('> div > .agendaItemEditForm input[name=code]').trigger(\"focus\").trigger(\"select\");\n    }\n\n    agendaItemAdd(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $newElement = $($('#agendaNewElementTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        this.prepareAgendaList($newElement.find('ol.agenda'), false);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.code').trigger(\"focus\");\n        $newElement.find(\".input-group.time\").datetimepicker({\n            locale: this.locale,\n            format: 'LT'\n        });\n    }\n\n    agendaDateAdd(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $newElement = $($('#agendaNewDateTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        this.prepareAgendaList($newElement.find('ol.agenda'), false);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find(\".input-group.date\").datetimepicker({\n            locale: this.locale,\n            format: 'dddd, Do MMMM YYYY'\n        });\n    }\n\n    showTimesChanges() {\n        if (this.$widget.find('.agendaItemAdder .showTimes input').prop(\"checked\")) {\n            this.$agenda.addClass('showTimes').removeClass('noShowTimes');\n        } else {\n            this.$agenda.removeClass('showTimes').addClass('noShowTimes');\n        }\n    }\n\n    prepareAgendaItem($item) {\n        $item.find('> div').prepend('<span class=\"glyphicon glyphicon-resize-vertical moveHandle\"></span>');\n        $item.find('> div > h3').append('<a href=\"#\" class=\"editAgendaItem\"><span class=\"glyphicon glyphicon-pencil\"></span></a>');\n        $item.find('> div > h3').append(this.delAgendaItemStr);\n        $item.find('li.checkbox').on('click', (ev) => {\n            ev.stopPropagation();\n        });\n    }\n\n    prepareAgendaList($list, full: boolean) {\n        let str = '<li class=\"agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled\">' +\n            '<a href=\"#\" class=\"addEntry\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddEntry') + '</a>';\n        if (full) {\n            str += '<a href=\"#\" class=\"addDate\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddDate') + '</a>' +\n                '<span class=\"spacer\"></span>' +\n            '<label class=\"showTimes\"><input type=\"checkbox\" class=\"showTimes\"> ' + __t('admin', 'agendaShowTimes') + '</label>';\n        }\n        str += '</li>';\n        const $el = $(str);\n        if (this.$agenda.hasClass('showTimes')) {\n            $el.find(\".showTimes input\").prop(\"checked\", true);\n        }\n        $list.append($el);\n    }\n\n    showSaver() {\n        $('#agendaEditSavingHolder').removeClass(\"hidden\");\n        this.hasChanged = true;\n        if (!$(\"body\").hasClass('testing')) {\n            $(window).on(\"beforeunload\", AgendaEdit.onLeavePage);\n        }\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n}\n"]}